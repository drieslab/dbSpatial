---
title: "Spatial Operations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Spatial Operations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Spatial Operations with {terra} Comparisons

```{r setup}
# load libs
library(dbSpatial)
library(terra)
library(dplyr)
```

## Create test data
```{r}
# Create a data.frame with x and y coordinates and attributes
coordinates <- data.frame(x = 1:1e3, y = 1:1e3)
attributes <- data.frame(id = 1:1e3, name = paste("A", 1:1e3, sep = "_"))

# Combine the coordinates and attributes
dummy_data <- cbind(coordinates, attributes)

# Create a SpatVector from the data.frame
dummy_spatvector <- terra::vect(dummy_data, geom = c("x", "y"))

# DuckDB
duckdb_conn = DBI::dbConnect(duckdb::duckdb(), ":memory:")

db_points = dbSpatial(conn = duckdb_conn,
                      name = "spatVector_proxy",
                      value = dummy_spatvector,
                      overwrite = TRUE)

# Preview points table
db_points |>
  dplyr::mutate(geom_text = ST_AsText(geom))
```


### Extent
```{r}
# terra
terra::ext(dummy_spatvector)

# dbSpatial
dbSpatial::ST_Extent(tbl = db_points)
```

### Shift
```{r, max.print=10}
# terra
head(terra::geom(dummy_spatvector))

shifted_spatVector = terra::shift(dummy_spatvector, dx = 10, dy = 10)

head(terra::geom(shifted_spatVector))

# dbSpatial
dbSpatial::ST_Translate(tbl = db_points, dx = 10, dy = 10) |>
  mutate(geom_text = ST_AsText(geom))
```

```{r, eval = FALSE, echo = FALSE}
### Flip

# terra
terra::geom(dummy_spatvector)

flipped_spatVector = terra::flip(dummy_spatvector, direction = "vertical")

terra::geom(flipped_spatVector)

# <----- not equivalent to terra::flip ------>
# dbSpatial
# db_points |>
#   mutate(points = ST_AsText(geom))
# 
# db_points |>
#   mutate(flipped_points = ST_AsText(ST_FlipCoordinates(geom)))

```

### Is.Valid
```{r}
# terra
head(terra::geom(dummy_spatvector))

head(terra::is.valid(dummy_spatvector))

dbSpatial::ST_IsValid(tbl = db_points)
```


### Y, X Max
```{r}
# terra
head(terra::geom(dummy_spatvector))

terra::ymax(dummy_spatvector)

terra::xmax(dummy_spatvector)

# dbSpatial
dbSpatial::ST_YMax(db_points)

dbSpatial::ST_XMax(db_points)

```

```{r, echo = FALSE}
### centroids

# # terra
# terra::geom(dummy_spatvector)
# 
# terra::centroids(dummy_spatvector)
```




